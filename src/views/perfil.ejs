<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Easy Tattoo</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/perfilUsuario.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/tema.css">

    <!-- √çcones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="menu-icon">‚ò∞</span>
            <h2 class="header-text">Easy Tattoo</h2>
        </div>

        <ul class="sidebar-menu">
            <li><a href="/perfil" class="active"><i class="fas fa-user"></i><span class="menu-text">Meu Perfil</span></a></li>
            <li><a href="/posts"><i class="fas fa-paint-brush"></i><span class="menu-text">Feed</span></a></li>
            <li><a href="/posts/criar"><i class="fas fa-plus"></i><span class="menu-text">Criar Post</span></a></li>
            <li><a href="/user/busca"><i class="fas fa-search"></i><span class="menu-text">Buscar</span></a></li>
            <li><a href="/sobre"><i class="fas fa-info-circle"></i><span class="menu-text">Sobre</span></a></li>
        </ul>

        <div class="sidebar-footer">
            <a href="/config"><i class="fas fa-cogs"></i><span class="menu-text">Configura√ß√µes</span></a>
            <a href="/logout"><i class="fas fa-sign-out-alt"></i><span class="menu-text">Logout</span></a>
        </div>
    </div>

    <!-- MODAL/POPUP OVERLAY -->
    <div class="profile-modal-overlay"></div>

    <!-- MODAL/POPUP CONTE√öDO -->
    <div class="profile-modal">
        
        <!-- CLOSE BUTTON -->
        <button class="modal-close" onclick="closeProfile()">
            <i class="fas fa-times"></i>
        </button>

        <!-- PERFIL -->
        <header class="profile-header">

            <!-- Avatar Moderno -->
            <div class="artist-avatar-letter">
                <%= user.nome.charAt(0).toUpperCase() %>
            </div>

            <div class="artist-info">
                <h1><%= user.nome %></h1>

                <% if (user.tipo==='tatuador' && user.estilos && user.estilos.length>0) { %>
                    <p><strong>‚ú® Especializa√ß√µes:</strong> <%= user.estilos.join(', ') %></p>
                <% } %>

                <% if (user.bio) { %>
                    <p><strong>üìù Sobre:</strong> <%= user.bio %></p>
                <% } %>

                <% if (user.cidade || user.estado) { %>
                    <p>
                        <strong>üìç Localiza√ß√£o:</strong>
                        <%= user.cidade || '' %><%= user.cidade && user.estado ? ', ' : '' %><%= user.estado || '' %>
                    </p>
                <% } %>

                <% if (user.telefone) { %>
                    <p><strong>üìû Telefone:</strong> <%= user.telefone %></p>
                <% } %>
            </div>

        </header>

        <!-- PUBLICA√á√ïES -->
        <section class="publications-section">
            <div class="section-header">
                <h2>üì∏ Minhas Publica√ß√µes</h2>
            </div>

            <div class="publications-list">

                <% if (posts && posts.length > 0) { %>

                    <% posts.forEach(post => { %>
                        <article class="publication-item" data-post-id="<%= post._id %>">

                            <img src="<%= post.imageUrl %>" 
                                 alt="<%= post.description %>" 
                                 class="publication-image"
                                 onerror="this.src='/img/tattoo1.jpg'">

                            <div class="publication-info">
                                <p class="description"><%= post.description %></p>

                                <p class="date">
                                    <i class="far fa-calendar"></i>
                                    <%= new Date(post.createdAt).toLocaleDateString('pt-BR') %>
                                </p>

                                <p class="stats">
                                    <i class="fas fa-heart"></i> <%= post.likesCount || 0 %> |
                                    <i class="fas fa-comment"></i> <%= post.comments?.length || 0 %>
                                </p>

                                <div class="publication-actions">
                                    <button type="button" class="icon-button" data-post-id="<%= post._id %>" data-image="<%= post.imageUrl %>" data-description="<%= post.description %>" onclick="openPostModal(event)">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>

                                    <button type="button" class="icon-button delete-btn" data-post-id="<%= post._id %>" onclick="deletePostFromProfile(event)">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>
                                </div>
                            </div>

                        </article>
                    <% }) %>

                <% } else { %>

                    <p>
                        üì≠ Voc√™ ainda n√£o tem publica√ß√µes.<br>
                        <a href="/posts/criar">Criar sua primeira publica√ß√£o</a>
                    </p>

                <% } %>

            </div>

        </section>

        <!-- ESTAT√çSTICAS -->
        <section class="statistics-section">
            <h2>üìä Estat√≠sticas e Feedback</h2>

            <div class="stats">
                <div class="stat-item">
                    <h3>Posts</h3>
                    <p><%= posts?.length || 0 %></p>
                </div>

                <div class="stat-item">
                    <h3>Total de Likes</h3>
                    <p><%= posts?.reduce((sum, p)=> sum + (p.likesCount || 0), 0) %></p>
                </div>

                <div class="stat-item">
                    <h3>Total de Coment√°rios</h3>
                    <p><%= posts?.reduce((sum, p)=> sum + (p.comments?.length || 0), 0) %></p>
                </div>
            </div>
        </section>

    </div>

    <!-- MODAL OVERLAY DO POST -->
    <div class="post-modal-overlay" id="postModalOverlay" onclick="closePostModal()"></div>

    <!-- MODAL DO POST AMPLIADO -->
    <div class="post-modal" id="postModal">
        <button class="modal-close" onclick="closePostModal()">
            <i class="fas fa-times"></i>
        </button>
        <img id="postModalImage" src="" alt="Post" class="post-modal-image">
        <p id="postModalDescription" class="post-modal-description"></p>
    </div>

    <!-- JS -->
    <script>
        console.log('Script carregado!');
        
        // Abrir modal com post ampliado
        function openPostModal(event) {
            console.log('openPostModal chamado!', event);
            event.preventDefault();
            event.stopPropagation();
            
            const btn = event.currentTarget;
            const postId = btn.dataset.postId;
            const image = btn.dataset.image;
            const description = btn.dataset.description;
            
            console.log('Abrindo modal do post:', postId, 'Image:', image);
            
            const modalImage = document.getElementById('postModalImage');
            const modalDesc = document.getElementById('postModalDescription');
            const modal = document.getElementById('postModal');
            const overlay = document.getElementById('postModalOverlay');
            
            if (modalImage) modalImage.src = image;
            if (modalDesc) modalDesc.textContent = description;
            if (modal) modal.classList.add('active');
            if (overlay) overlay.classList.add('active');
        }

        // Fechar modal
        function closePostModal() {
            console.log('Fechando modal');
            const modal = document.getElementById('postModal');
            const overlay = document.getElementById('postModalOverlay');
            if (modal) modal.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
        }

        // Deletar post do perfil
        async function deletePostFromProfile(event) {
            console.log('deletePostFromProfile chamado!', event);
            event.preventDefault();
            event.stopPropagation();
            
            const btn = event.currentTarget;
            const postId = btn.dataset.postId;
            
            console.log('Tentando deletar post:', postId);
            
            if (!confirm("Tem certeza que deseja excluir este post permanentemente?")) {
                console.log('Exclus√£o cancelada pelo usu√°rio');
                return;
            }

            try {
                console.log('Enviando requisi√ß√£o DELETE para /posts/' + postId);
                
                const response = await fetch(`/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log('Status da resposta:', response.status);
                const data = await response.json();
                console.log('Dados da resposta:', data);

                if (response.ok) {
                    alert('‚úÖ Post exclu√≠do com sucesso!');
                    
                    // Remover o elemento do DOM
                    const postElement = document.querySelector(`[data-post-id="${postId}"]`).closest('.publication-item');
                    if (postElement) {
                        postElement.style.opacity = '0';
                        postElement.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            postElement.remove();
                            console.log('Post removido do DOM');
                        }, 300);
                    }
                } else {
                    alert('‚ùå Erro ao excluir: ' + (data.error || 'Erro desconhecido'));
                    console.error('Erro na resposta:', data);
                }
            } catch (err) {
                console.error('Erro na requisi√ß√£o:', err);
                alert('‚ùå Erro ao excluir: ' + err.message);
            }
        }
        
        // Inicializar event listeners
        console.log('Inicializando event listeners...');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded!');
            
            // Adicionar listeners aos bot√µes Ver
            const openButtons = document.querySelectorAll('button[onclick*="openPostModal"]');
            console.log('Encontrados', openButtons.length, 'bot√µes Ver');
            openButtons.forEach((btn, index) => {
                btn.addEventListener('click', openPostModal);
                console.log('Listener adicionado ao bot√£o Ver', index);
            });
            
            // Adicionar listeners aos bot√µes Excluir
            const deleteButtons = document.querySelectorAll('button[onclick*="deletePostFromProfile"]');
            console.log('Encontrados', deleteButtons.length, 'bot√µes Excluir');
            deleteButtons.forEach((btn, index) => {
                btn.addEventListener('click', deletePostFromProfile);
                console.log('Listener adicionado ao bot√£o Excluir', index);
            });
            
            // Fechar modal ao clicar no overlay
            const postModalOverlay = document.getElementById('postModalOverlay');
            if (postModalOverlay) {
                postModalOverlay.addEventListener('click', closePostModal);
                console.log('Listener adicionado ao overlay');
            }
        });
    </script>

    <script src="/js/script.js"></script>

</body>
</html>